"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _lib = require("../../../lib");

var _fakeDriver = require("../protocol/fake-driver");

var _ws = _interopRequireDefault(require("ws"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _helpers = require("../../helpers");

describe('Websockets (e2e)', function () {
  let baseServer;
  let driver;
  let port;
  const SESSION_ID = 'foo';
  const WS_DATA = 'Hello';
  before(async function () {
    driver = new _fakeDriver.FakeDriver();
    driver.sessionId = SESSION_ID;
    port = await (0, _helpers.getTestPort)();
    baseServer = await (0, _lib.server)({
      routeConfiguringFunction: (0, _lib.routeConfiguringFunction)(driver),
      port
    });
  });
  after(async function () {
    await baseServer.close();
  });
  describe('web sockets support', function () {
    it('should be able to add websocket handler and remove it', async function () {
      const wss = new _ws.default.Server({
        noServer: true
      });
      wss.on('connection', ws => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(WS_DATA);
        }
      });
      const previousListenerCount = baseServer.listenerCount('upgrade');
      const endpoint = `${_lib.DEFAULT_WS_PATHNAME_PREFIX}/hello`;
      const timeout = 5000;
      await baseServer.addWebSocketHandler(endpoint, wss);
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);

      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(1);

      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://${_helpers.TEST_HOST}:${port}${endpoint}`);
        client.once('connection', (ws, req) => {
          try {
            ws.should.not.be.empty;
            req.connection.remoteAddress.should.not.be.empty;
          } catch (e) {
            reject(e);
          }
        });
        client.once('message', data => {
          const dataStr = _lodash.default.isString(data) ? data : data.toString();
          dataStr.should.eql(WS_DATA);
          resolve();
        });
        client.once('error', reject);
        setTimeout(() => reject(new Error('No websocket messages have been received after the timeout')), timeout);
      });
      (await baseServer.removeWebSocketHandler(endpoint)).should.be.true;

      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(0);

      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://${_helpers.TEST_HOST}:${port}${endpoint}`);
        client.on('message', data => reject(new Error(`No websocket messages are expected after the handler ` + `has been removed. '${data}' is received instead. `)));
        client.on('error', resolve);
        setTimeout(resolve, timeout);
      });
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZXNjcmliZSIsImJhc2VTZXJ2ZXIiLCJkcml2ZXIiLCJwb3J0IiwiU0VTU0lPTl9JRCIsIldTX0RBVEEiLCJiZWZvcmUiLCJGYWtlRHJpdmVyIiwic2Vzc2lvbklkIiwiZ2V0VGVzdFBvcnQiLCJzZXJ2ZXIiLCJyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24iLCJhZnRlciIsImNsb3NlIiwiaXQiLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZWFkeVN0YXRlIiwiT1BFTiIsInNlbmQiLCJwcmV2aW91c0xpc3RlbmVyQ291bnQiLCJsaXN0ZW5lckNvdW50IiwiZW5kcG9pbnQiLCJERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCIsInRpbWVvdXQiLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwic2hvdWxkIiwiYmUiLCJhYm92ZSIsIl8iLCJrZXlzIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJsZW5ndGgiLCJlcWwiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsImNsaWVudCIsIlRFU1RfSE9TVCIsIm9uY2UiLCJyZXEiLCJub3QiLCJlbXB0eSIsImNvbm5lY3Rpb24iLCJyZW1vdGVBZGRyZXNzIiwiZSIsImRhdGEiLCJkYXRhU3RyIiwiaXNTdHJpbmciLCJ0b1N0cmluZyIsInNldFRpbWVvdXQiLCJFcnJvciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJ0cnVlIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdGVzdC9lMmUvYmFzZWRyaXZlci93ZWJzb2NrZXRzLmUyZS5zcGVjLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge3NlcnZlciwgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uLCBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0gZnJvbSAnLi4vLi4vLi4vbGliJztcbmltcG9ydCB7RmFrZURyaXZlcn0gZnJvbSAnLi4vcHJvdG9jb2wvZmFrZS1kcml2ZXInO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQge1RFU1RfSE9TVCwgZ2V0VGVzdFBvcnR9IGZyb20gJy4uLy4uL2hlbHBlcnMnO1xuXG5kZXNjcmliZSgnV2Vic29ja2V0cyAoZTJlKScsIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGJhc2VTZXJ2ZXI7XG4gIGxldCBkcml2ZXI7XG4gIGxldCBwb3J0O1xuICBjb25zdCBTRVNTSU9OX0lEID0gJ2Zvbyc7XG4gIGNvbnN0IFdTX0RBVEEgPSAnSGVsbG8nO1xuXG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgZHJpdmVyID0gbmV3IEZha2VEcml2ZXIoKTtcbiAgICBkcml2ZXIuc2Vzc2lvbklkID0gU0VTU0lPTl9JRDtcbiAgICBwb3J0ID0gYXdhaXQgZ2V0VGVzdFBvcnQoKTtcbiAgICBiYXNlU2VydmVyID0gYXdhaXQgc2VydmVyKHtcbiAgICAgIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbjogcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uKGRyaXZlciksXG4gICAgICBwb3J0LFxuICAgIH0pO1xuICB9KTtcbiAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGJhc2VTZXJ2ZXIuY2xvc2UoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3dlYiBzb2NrZXRzIHN1cHBvcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIGFkZCB3ZWJzb2NrZXQgaGFuZGxlciBhbmQgcmVtb3ZlIGl0JywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe1xuICAgICAgICBub1NlcnZlcjogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzKSA9PiB7XG4gICAgICAgIGlmICh3cyAmJiB3cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgIHdzLnNlbmQoV1NfREFUQSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgcHJldmlvdXNMaXN0ZW5lckNvdW50ID0gYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJyk7XG4gICAgICBjb25zdCBlbmRwb2ludCA9IGAke0RFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYfS9oZWxsb2A7XG4gICAgICBjb25zdCB0aW1lb3V0ID0gNTAwMDtcbiAgICAgIGF3YWl0IGJhc2VTZXJ2ZXIuYWRkV2ViU29ja2V0SGFuZGxlcihlbmRwb2ludCwgd3NzKTtcbiAgICAgIGJhc2VTZXJ2ZXIubGlzdGVuZXJDb3VudCgndXBncmFkZScpLnNob3VsZC5iZS5hYm92ZShwcmV2aW91c0xpc3RlbmVyQ291bnQpO1xuICAgICAgXy5rZXlzKGF3YWl0IGJhc2VTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMoKSkubGVuZ3RoLnNob3VsZC5lcWwoMSk7XG4gICAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBXZWJTb2NrZXQoYHdzOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0ke2VuZHBvaW50fWApO1xuICAgICAgICBjbGllbnQub25jZSgnY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHdzLnNob3VsZC5ub3QuYmUuZW1wdHk7XG4gICAgICAgICAgICByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLnNob3VsZC5ub3QuYmUuZW1wdHk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNsaWVudC5vbmNlKCdtZXNzYWdlJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBjb25zdCBkYXRhU3RyID0gXy5pc1N0cmluZyhkYXRhKSA/IGRhdGEgOiBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgZGF0YVN0ci5zaG91bGQuZXFsKFdTX0RBVEEpO1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNsaWVudC5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICAgKCkgPT4gcmVqZWN0KG5ldyBFcnJvcignTm8gd2Vic29ja2V0IG1lc3NhZ2VzIGhhdmUgYmVlbiByZWNlaXZlZCBhZnRlciB0aGUgdGltZW91dCcpKSxcbiAgICAgICAgICB0aW1lb3V0XG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgICAgKGF3YWl0IGJhc2VTZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihlbmRwb2ludCkpLnNob3VsZC5iZS50cnVlO1xuICAgICAgXy5rZXlzKGF3YWl0IGJhc2VTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMoKSkubGVuZ3RoLnNob3VsZC5lcWwoMCk7XG4gICAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBXZWJTb2NrZXQoYHdzOi8vJHtURVNUX0hPU1R9OiR7cG9ydH0ke2VuZHBvaW50fWApO1xuICAgICAgICBjbGllbnQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT5cbiAgICAgICAgICByZWplY3QoXG4gICAgICAgICAgICBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGBObyB3ZWJzb2NrZXQgbWVzc2FnZXMgYXJlIGV4cGVjdGVkIGFmdGVyIHRoZSBoYW5kbGVyIGAgK1xuICAgICAgICAgICAgICAgIGBoYXMgYmVlbiByZW1vdmVkLiAnJHtkYXRhfScgaXMgcmVjZWl2ZWQgaW5zdGVhZC4gYFxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgICAgY2xpZW50Lm9uKCdlcnJvcicsIHJlc29sdmUpO1xuICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpO1xuICAgICAgfSk7XG4gICAgICBiYXNlU2VydmVyLmxpc3RlbmVyQ291bnQoJ3VwZ3JhZGUnKS5zaG91bGQuYmUuYWJvdmUocHJldmlvdXNMaXN0ZW5lckNvdW50KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUFBLFFBQVEsQ0FBQyxrQkFBRCxFQUFxQixZQUFZO0VBQ3ZDLElBQUlDLFVBQUo7RUFDQSxJQUFJQyxNQUFKO0VBQ0EsSUFBSUMsSUFBSjtFQUNBLE1BQU1DLFVBQVUsR0FBRyxLQUFuQjtFQUNBLE1BQU1DLE9BQU8sR0FBRyxPQUFoQjtFQUVBQyxNQUFNLENBQUMsa0JBQWtCO0lBQ3ZCSixNQUFNLEdBQUcsSUFBSUssc0JBQUosRUFBVDtJQUNBTCxNQUFNLENBQUNNLFNBQVAsR0FBbUJKLFVBQW5CO0lBQ0FELElBQUksR0FBRyxNQUFNLElBQUFNLG9CQUFBLEdBQWI7SUFDQVIsVUFBVSxHQUFHLE1BQU0sSUFBQVMsV0FBQSxFQUFPO01BQ3hCQyx3QkFBd0IsRUFBRSxJQUFBQSw2QkFBQSxFQUF5QlQsTUFBekIsQ0FERjtNQUV4QkM7SUFGd0IsQ0FBUCxDQUFuQjtFQUlELENBUkssQ0FBTjtFQVNBUyxLQUFLLENBQUMsa0JBQWtCO0lBQ3RCLE1BQU1YLFVBQVUsQ0FBQ1ksS0FBWCxFQUFOO0VBQ0QsQ0FGSSxDQUFMO0VBSUFiLFFBQVEsQ0FBQyxxQkFBRCxFQUF3QixZQUFZO0lBQzFDYyxFQUFFLENBQUMsdURBQUQsRUFBMEQsa0JBQWtCO01BQzVFLE1BQU1DLEdBQUcsR0FBRyxJQUFJQyxXQUFBLENBQVVDLE1BQWQsQ0FBcUI7UUFDL0JDLFFBQVEsRUFBRTtNQURxQixDQUFyQixDQUFaO01BR0FILEdBQUcsQ0FBQ0ksRUFBSixDQUFPLFlBQVAsRUFBc0JDLEVBQUQsSUFBUTtRQUMzQixJQUFJQSxFQUFFLElBQUlBLEVBQUUsQ0FBQ0MsVUFBSCxLQUFrQkwsV0FBQSxDQUFVTSxJ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