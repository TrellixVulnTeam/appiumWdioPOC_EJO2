'use strict';

require("source-map-support/register");

const B = require('bluebird');

const globby = require('globby');

const _ = require('lodash');

const cp = require('child_process');

const spawn = cp.spawn;
const exec = B.promisify(cp.exec);

const path = require('path');

const utils = require('../utils');

const log = require('fancy-log');

const configure = function configure(gulp, opts, env) {
  let npmBin;
  gulp.task('npm-bin', async function getNpmBin() {
    if (npmBin) {
      return B.resolve();
    }

    let bin = await exec('npm bin');

    if (Array.isArray(bin)) {
      bin = bin[0];
    }

    npmBin = bin.trim();
    log(`Determined npm bin: ${npmBin}`);
  });

  const doCoverage = function doCoverage(taskName, filePatterns, targetDir) {
    const subTaskName = `${taskName}:run`;
    const covTestFiles = utils.translatePaths([filePatterns], env.fileAliases);
    gulp.task(subTaskName, async function doSubTask() {
      const files = await globby(covTestFiles);
      const bins = ['nyc', '_mocha'].reduce(function getFullPaths(bins, item) {
        bins[item] = path.resolve(npmBin, item);
        return bins;
      }, {});
      const args = ['--reporter=lcov', '--reporter=text-lcov', '--reporter=cobertura', `--report-dir=${targetDir}`, '--exclude-after-remap=false', bins._mocha, '--reporter=dot', ...files, '--exit'];

      let env = _.clone(process.env);

      env.NO_PRECOMPILE = 1;
      env._TESTING = 1;
      env.NODE_ENV = 'coverage';
      log(`Running command: ${bins.nyc} ${args.join(' ')}`);
      return new B(function runCmd(resolve, reject) {
        const proc = spawn(bins.nyc, args, {
          env,
          stdio: opts.coverage.verbose ? 'inherit' : 'ignore'
        });
        proc.on('close', function onClose(code) {
          if (code === 0) {
            resolve();
          } else {
            reject(new Error(`Coverage command exit code: ${code}`));
          }
        });
        proc.on('error', function onError(err) {
          reject(new Error(`Coverage error: ${err}`));
        });
      });
    });
    gulp.task(taskName, gulp.series('clean', 'transpile', 'npm-bin', subTaskName));
  };

  if (opts.coverage) {
    doCoverage('coverage', opts.coverage.files, 'coverage');
    ['coveralls:run', 'coveralls'].map(taskName => gulp.task(taskName, function reportDeprecatedCoveralls() {
      log(`Coveralls integration has been removed as per ` + `https://github.com/appium/appium/issues/14648. ` + `Nothing will be done in scope of '${taskName}' task`);
    }));
  }

  if (opts['coverage-e2e']) {
    doCoverage('coverage-e2e', opts['coverage-e2e'].files, 'coverage-e2e');
  }
};

module.exports = {
  configure
};require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3Rhc2tzL2NvdmVyYWdlLmpzIiwibmFtZXMiOlsiQiIsInJlcXVpcmUiLCJnbG9iYnkiLCJfIiwiY3AiLCJzcGF3biIsImV4ZWMiLCJwcm9taXNpZnkiLCJwYXRoIiwidXRpbHMiLCJsb2ciLCJjb25maWd1cmUiLCJndWxwIiwib3B0cyIsImVudiIsIm5wbUJpbiIsInRhc2siLCJnZXROcG1CaW4iLCJyZXNvbHZlIiwiYmluIiwiQXJyYXkiLCJpc0FycmF5IiwidHJpbSIsImRvQ292ZXJhZ2UiLCJ0YXNrTmFtZSIsImZpbGVQYXR0ZXJucyIsInRhcmdldERpciIsInN1YlRhc2tOYW1lIiwiY292VGVzdEZpbGVzIiwidHJhbnNsYXRlUGF0aHMiLCJmaWxlQWxpYXNlcyIsImRvU3ViVGFzayIsImZpbGVzIiwiYmlucyIsInJlZHVjZSIsImdldEZ1bGxQYXRocyIsIml0ZW0iLCJhcmdzIiwiX21vY2hhIiwiY2xvbmUiLCJwcm9jZXNzIiwiTk9fUFJFQ09NUElMRSIsIl9URVNUSU5HIiwiTk9ERV9FTlYiLCJueWMiLCJqb2luIiwicnVuQ21kIiwicmVqZWN0IiwicHJvYyIsInN0ZGlvIiwiY292ZXJhZ2UiLCJ2ZXJib3NlIiwib24iLCJvbkNsb3NlIiwiY29kZSIsIkVycm9yIiwib25FcnJvciIsImVyciIsInNlcmllcyIsIm1hcCIsInJlcG9ydERlcHJlY2F0ZWRDb3ZlcmFsbHMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiIsInNvdXJjZXMiOlsibGliL3Rhc2tzL2NvdmVyYWdlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgQiA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCBnbG9iYnkgPSByZXF1aXJlKCdnbG9iYnknKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGNwID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuY29uc3Qgc3Bhd24gPSBjcC5zcGF3bjtcbmNvbnN0IGV4ZWMgPSBCLnByb21pc2lmeShjcC5leGVjKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzJyk7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdmYW5jeS1sb2cnKTtcblxuY29uc3QgY29uZmlndXJlID0gZnVuY3Rpb24gY29uZmlndXJlKGd1bHAsIG9wdHMsIGVudikge1xuICBsZXQgbnBtQmluO1xuICBndWxwLnRhc2soJ25wbS1iaW4nLCBhc3luYyBmdW5jdGlvbiBnZXROcG1CaW4oKSB7XG4gICAgaWYgKG5wbUJpbikge1xuICAgICAgcmV0dXJuIEIucmVzb2x2ZSgpO1xuICAgIH1cbiAgICBsZXQgYmluID0gYXdhaXQgZXhlYygnbnBtIGJpbicpO1xuICAgIGlmIChBcnJheS5pc0FycmF5KGJpbikpIHtcbiAgICAgIGJpbiA9IGJpblswXTtcbiAgICB9XG4gICAgbnBtQmluID0gYmluLnRyaW0oKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF0b21pYy11cGRhdGVzXG4gICAgbG9nKGBEZXRlcm1pbmVkIG5wbSBiaW46ICR7bnBtQmlufWApO1xuICB9KTtcblxuICBjb25zdCBkb0NvdmVyYWdlID0gZnVuY3Rpb24gZG9Db3ZlcmFnZSh0YXNrTmFtZSwgZmlsZVBhdHRlcm5zLCB0YXJnZXREaXIpIHtcbiAgICBjb25zdCBzdWJUYXNrTmFtZSA9IGAke3Rhc2tOYW1lfTpydW5gO1xuICAgIGNvbnN0IGNvdlRlc3RGaWxlcyA9IHV0aWxzLnRyYW5zbGF0ZVBhdGhzKFtmaWxlUGF0dGVybnNdLCBlbnYuZmlsZUFsaWFzZXMpO1xuICAgIGd1bHAudGFzayhzdWJUYXNrTmFtZSwgYXN5bmMgZnVuY3Rpb24gZG9TdWJUYXNrKCkge1xuICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBnbG9iYnkoY292VGVzdEZpbGVzKTtcbiAgICAgIGNvbnN0IGJpbnMgPSBbJ255YycsICdfbW9jaGEnXS5yZWR1Y2UoZnVuY3Rpb24gZ2V0RnVsbFBhdGhzKGJpbnMsIGl0ZW0pIHtcbiAgICAgICAgYmluc1tpdGVtXSA9IHBhdGgucmVzb2x2ZShucG1CaW4sIGl0ZW0pO1xuICAgICAgICByZXR1cm4gYmlucztcbiAgICAgIH0sIHt9KTtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAgICctLXJlcG9ydGVyPWxjb3YnLFxuICAgICAgICAnLS1yZXBvcnRlcj10ZXh0LWxjb3YnLCAvLyBDb3ZlcmFsbHMgY29uc3VtZXMgbGNvdiBhbmQgdGV4dC1sY292IHJlcG9ydHNcbiAgICAgICAgJy0tcmVwb3J0ZXI9Y29iZXJ0dXJhJywgLy8gTVMgQXp1cmUgY29uc3VtZXMgQ29iZXJ0dXJhIGNvdmVyYWdlIHJlcG9ydHNcbiAgICAgICAgYC0tcmVwb3J0LWRpcj0ke3RhcmdldERpcn1gLFxuICAgICAgICAnLS1leGNsdWRlLWFmdGVyLXJlbWFwPWZhbHNlJyxcbiAgICAgICAgYmlucy5fbW9jaGEsXG4gICAgICAgICctLXJlcG9ydGVyPWRvdCcsXG4gICAgICAgIC4uLmZpbGVzLFxuICAgICAgICAnLS1leGl0JyxcbiAgICAgIF07XG4gICAgICBsZXQgZW52ID0gXy5jbG9uZShwcm9jZXNzLmVudik7XG4gICAgICBlbnYuTk9fUFJFQ09NUElMRSA9IDE7XG4gICAgICBlbnYuX1RFU1RJTkcgPSAxO1xuICAgICAgZW52Lk5PREVfRU5WID0gJ2NvdmVyYWdlJztcbiAgICAgIGxvZyhgUnVubmluZyBjb21tYW5kOiAke2JpbnMubnljfSAke2FyZ3Muam9pbignICcpfWApO1xuICAgICAgcmV0dXJuIG5ldyBCKGZ1bmN0aW9uIHJ1bkNtZChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgY29uc3QgcHJvYyA9IHNwYXduKGJpbnMubnljLCBhcmdzLCB7XG4gICAgICAgICAgZW52LFxuICAgICAgICAgIHN0ZGlvOiBvcHRzLmNvdmVyYWdlLnZlcmJvc2UgPyAnaW5oZXJpdCcgOiAnaWdub3JlJyxcbiAgICAgICAgfSk7XG4gICAgICAgIHByb2Mub24oJ2Nsb3NlJywgZnVuY3Rpb24gb25DbG9zZShjb2RlKSB7XG4gICAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgQ292ZXJhZ2UgY29tbWFuZCBleGl0IGNvZGU6ICR7Y29kZX1gKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcHJvYy5vbignZXJyb3InLCBmdW5jdGlvbiBvbkVycm9yKGVycikge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYENvdmVyYWdlIGVycm9yOiAke2Vycn1gKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZ3VscC50YXNrKHRhc2tOYW1lLCBndWxwLnNlcmllcygnY2xlYW4nLCAndHJhbnNwaWxlJywgJ25wbS1iaW4nLCBzdWJUYXNrTmFtZSkpO1xuICB9O1xuXG4gIGlmIChvcHRzLmNvdmVyYWdlKSB7XG4gICAgZG9Db3ZlcmFnZSgnY292ZXJhZ2UnLCBvcHRzLmNvdmVyYWdlLmZpbGVzLCAnY292ZXJhZ2UnKTtcbiAgICBbJ2NvdmVyYWxsczpydW4nLCAnY292ZXJhbGxzJ10ubWFwKCh0YXNrTmFtZSkgPT5cbiAgICAgIGd1bHAudGFzayh0YXNrTmFtZSwgZnVuY3Rpb24gcmVwb3J0RGVwcmVjYXRlZENvdmVyYWxscygpIHtcbiAgICAgICAgbG9nKFxuICAgICAgICAgIGBDb3ZlcmFsbHMgaW50ZWdyYXRpb24gaGFzIGJlZW4gcmVtb3ZlZCBhcyBwZXIgYCArXG4gICAgICAgICAgICBgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzE0NjQ4LiBgICtcbiAgICAgICAgICAgIGBOb3RoaW5nIHdpbGwgYmUgZG9uZSBpbiBzY29wZSBvZiAnJHt0YXNrTmFtZX0nIHRhc2tgXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgaWYgKG9wdHNbJ2NvdmVyYWdlLWUyZSddKSB7XG4gICAgZG9Db3ZlcmFnZSgnY292ZXJhZ2UtZTJlJywgb3B0c1snY292ZXJhZ2UtZTJlJ10uZmlsZXMsICdjb3ZlcmFnZS1lMmUnKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNvbmZpZ3VyZSxcbn07XG4iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFqQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1FLENBQUMsR0FBR0YsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUcsRUFBRSxHQUFHSCxPQUFPLENBQUMsZUFBRCxDQUFsQjs7QUFDQSxNQUFNSSxLQUFLLEdBQUdELEVBQUUsQ0FBQ0MsS0FBakI7QUFDQSxNQUFNQyxJQUFJLEdBQUdOLENBQUMsQ0FBQ08sU0FBRixDQUFZSCxFQUFFLENBQUNFLElBQWYsQ0FBYjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdQLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1RLEtBQUssR0FBR1IsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTVMsR0FBRyxHQUFHVCxPQUFPLENBQUMsV0FBRCxDQUFuQjs7QUFFQSxNQUFNVSxTQUFTLEdBQUcsU0FBU0EsU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUJDLElBQXpCLEVBQStCQyxHQUEvQixFQUFvQztFQUNwRCxJQUFJQyxNQUFKO0VBQ0FILElBQUksQ0FBQ0ksSUFBTCxDQUFVLFNBQVYsRUFBcUIsZUFBZUMsU0FBZixHQUEyQjtJQUM5QyxJQUFJRixNQUFKLEVBQVk7TUFDVixPQUFPZixDQUFDLENBQUNrQixPQUFGLEVBQVA7SUFDRDs7SUFDRCxJQUFJQyxHQUFHLEdBQUcsTUFBTWIsSUFBSSxDQUFDLFNBQUQsQ0FBcEI7O0lBQ0EsSUFBSWMsS0FBSyxDQUFDQyxPQUFOLENBQWNGLEdBQWQsQ0FBSixFQUF3QjtN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
